{% extends 'base/base.html' %}
{% load bootstrap4 %}
{% block main %}

<body onload="loadTest()">
    <br>
    <br>
    <br>
    <br>
    <br>
        
{% load bootstrap4 %}
<div class="col-lg-8 posts-list" >
	<form id="addAccount">
		<h2>Seleccione el origen</h2>
		<br>	
			<div id="separatorOrigin">
				
			</div>
			<br>		
	</form>
	<div id="separatorOriginButton" style="display:none">
        <button  onclick="generateAccount()" id="generatorAccount" class="genric-btn primary small">GENERAR CUENTA CONTABLE DE</button>
	</div>
</div>
<br>
<div id=divCreateAccount class="container-fluid" style="display:none">
	<div class="card mb-3">
		<div class="card-header"><i class="fas fa-table mr-1"></i>Configuración Cuenta Contable</div>
		<div class="card-body">
                <br>
                <form>
                    <div class="form-row">
                        <div class="col-6">
                            <div  class="container-fluid mb-3" style="float:left">
                                <div class="card" >
                                <div class="card-header mb-3" ><i class="fas fa-table mr-1" ></i>Rubro Presupuesto</div>
                                    <div class="card-body" >
                                        <div class="table-responsive">
                                            
                                            <table class="table table-bordered dataTable" id="dataTableAccountRubro" cellspacing="0" 
                                                role="grid" aria-describedby="dataTable_accountRubro">
                                                
                                                <thead>
                                                    <tr>
                                                        <th>Rubro</th>
                                                        <th>Descripción</th>
                                                        <th>Tipo</th>
                                                    </tr>
                                                </thead>
                                                <tfoot>
                                                    <tr>
                                                        <th>Rubro</th>
                                                        <th>Descripción</th>
                                                        <th>Tipo</th>
                                                    </tr>
                                                </tfoot>
                                                </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div id="divAccount" class="container-fluid col-6" style="display:block">
                            <div class="card">
                                <div class="card-header mb-3"><i class="fas fa-table mr-1"></i>Cuentas Contables-Operación-Tipo</div>
                                <form id="createAccuont" class="col-6">
                                    <div class="form-row col-12">
                                        <div class="col-7 mb-4" >
                                            <label>Cuenta:</label>
                                            <select class="form-control" id="accountSelect" name="accountSelect" >
                                            </select>
                                        </div>
                                        <div class="col-5 mb-4" >
                                            <label>Operación:</label>
                                            <select class="form-control" id="operationSelect" name="operationSelect" >
                                                <option value="selectionO" selected>----------</option>
                                                <option value="debito">Débito</option>      
                                                <option value="credito">Crédito</option>
                                            </select>
                                        </div>	                                       
                                    </div>
                                    <div class="col-5 mb-4" >
                                        <label>Operación Cuenta:</label>
                                        <select class="form-control" id="operationAccountSelect" name="operationAccountSelect">
                                            <option value="selectionOC" selected>----------</option>
                                            <option value="obligacion">Obligación</option>      
                                            <option value="comprobantePago">Comprobante de pago</option>
                                        </select>
                                    </div>
                                    <div class="form-row col-5 mb-4">
                                        <div>
                                            <button onclick="createAccount(1)" type="button" id="addAccountOperation"class="btn btn-primary">Agregar</button>
                                            <button type="button" class="btn btn-secondary">Cancelar</button>
                                        </div>					
                                    </div>
                                </form>   
                                <div class="container-fluid mb-2" style="float:left">
                                    <div class="card">
                                    <div class="card-header mb-2" ><i class="fas fa-table mr-1" ></i>Cuenta</div>
                                        <div class="card-body" >
                                            <div class="table-responsive">
                                                <table class="table table-bordered dataTable" id="dataTableAccountingOp" cellspacing="0" 
                                                    role="grid" aria-describedby="dataTable_accountOp">
                                                    
                                                    <thead>
                                                        <tr>
                                                            <th>Cuenta</th>
                                                            <th>Doc. Presupuesto</th>
                                                            <th>Débito-Crédito</th>
                                                            <th>Acciones</th>
                                                        </tr>
                                                    </thead>
                                                    <tfoot>
                                                        <tr>
                                                            <th>Cuenta</th>
                                                            <th>Doc. Presupuesto</th>
                                                            <th>Débito-Crédito</th>
                                                            <th>Acciones</th>
                                                        </tr>
                                                    </tfoot>
                                                    </table>
                                            </div>    
                                        </div>
                                    </div>
                                </div>  
                            </div>
                        </div>
                    </div>
                </form>	
		</div>	
	</div>
</div>
<script>

var dataRow;
var accountId;
var originID=0;

$(document).ready(function() {
		$('#dataTableAccountingOp').DataTable( {
			
		  "destroy":true,
		  "language": idioma_español,
		  
			dom: 'Bfrtip',			
		  }
		  );		 	

		$('#dataTableAccountRubro').DataTable( {
			
		  "destroy":true,
		  "language": idioma_español,
		  
			dom: 'Bfrtip',			
		  }
		  );	       	 	

    var table = $('#dataTableAccountRubro').DataTable();
 
    $('#dataTableAccountRubro tbody').on( 'click', 'tr', function () {
        if ( $(this).hasClass('selected') ) {
            $(this).removeClass('selected');
        }
        else {
            table.$('tr.selected').removeClass('selected');
            $(this).addClass('selected');
            dataRow = table.row( this ).data();

        }
    } );

 
} );


function loadTest() {	
	$.ajax({
		url: '{% url "getOriginBudget"  0 %}'.replace('0', localStorage.getItem('userID')),
		data: {
			'option': '1',
			'nameAC': localStorage.getItem('nameAC'),
			'idBussines': localStorage.getItem('idBussines'),

		},
		dataType: 'json',
		success: function (data) {
			
		for (var i=0; i<data.OR.length; i++){
			$('#separatorOrigin')
			.append(`<div class="custom-control custom-radio custom-control-inline">
			<input onclick="generateButton()" type="radio" class="custom-control-input" value="`+data.OR[i].nameOrigin+`" id="`+data.OR[i].nameOrigin+`"name="origins">
			<label class="custom-control-label" for="`+data.OR[i].nameOrigin+`">`+data.OR[i].nameOrigin+`</label>
			</div>`)
			}
		}			
	});		
}
function generateButton(){
	var nameOrigin = $('input[name=origins]:checked', '#addAccount').val();
	$("#divCreateAccount").css("display", "none");	
	$("#generatorAccount").text("GENERAR CUENTA CONTABLE DE "+ nameOrigin)															
	$("#separatorOriginButton").css("display", "block");
    $.ajax({
		url: '{% url "getBudget"  0 %}'.replace('0', localStorage.getItem('userID')),
		data: {
			'nameOrigin': nameOrigin,
			'nameAC': localStorage.getItem('nameAC'),
			'idBussines': localStorage.getItem('idBussines')
		},
		dataType: 'json',
		success: function (data) {

			var table = $('#dataTableAccountRubro').DataTable(); 
 			var rows = table.rows().remove().draw();
			originID = data.ID;
			for (var i=0; i<data.RUBRO.length; i++){
				table.row.add( [
				data.RUBRO[i].rubro,
				data.RUBRO[i].description,			
				"PRESUPUESTO DE "+nameOrigin,			
				])
			}

			table.draw( false );
										
		}
	});
}
function generateAccount(){
    $("#divCreateAccount").css("display", "block");
    $("#divCreateAccount").css("display", "block");
    $("#divCreateAccount").css("display", "block");
    nameAccount = $("#accountSelect option:selected").text();

    $.ajax({
        url: '{% url "getAccountSettings"  0 %}'.replace('0', localStorage.getItem('userID')),
        data: {
            'bussinesId': localStorage.getItem('idBussines'),
        },
        dataType: 'json',
        success: function (data) {
            const $select = document.querySelector("#accountSelect");
        
            for (let i = $select.options.length; i >= 0; i--) {
                $select.remove(i);
            }
            $('#accountSelect').append(`<option  hidden  selected"> Selecciona una opción</option>`);
            for (var i=0; i<data.ACC.length; i++){
            $('#accountSelect').append(`<option value="${data.ACC[i].id}">${data.ACC[i].code}`+' '+ `${data.ACC[i].description} </option>`);
            }						
        }       
    });
}

function createAccount(option){
    console.log(dataRow)

    swal({
        title: "Desea agregar la cuenta ?",
        text: "Al confirmar esta acción, la cuenta sera guardada",
        icon: "warning",
        buttons: true,
        dangerMode: true,
        }).then((willDelete) => {
        if (willDelete) {
             
			var account = $("#accountSelect option:selected").text();
			var operation = $("#operationSelect option:selected").text();
			var operationAccount = $("#operationAccountSelect option:selected").text();
			if (account,operation,operationAccount) {
				// Create Ajax Call
				$.ajax({
					url: '{% url "createAccountingOpTip"  0 %}'.replace('0', localStorage.getItem('userID')),
					data: {
						'bussines':localStorage.getItem('idBussines'), 
						'account': account,
						'operation': operation,
						'operationAccount': operationAccount,
					},
					dataType: 'json',
					success: function (data) {
                        console.log(data);
                        if(data.CREATE == "TRUE"){
                            var tableAccountingOp = $('#dataTableAccountingOp').DataTable(); 
                            var rows = tableAccountingOp.rows().remove().draw();
                            for (var i=0; i<data.AG.length; i++){
                                        
                                tableAccountingOp.row.add( [
                                data.ACCO[i].account,
                                data.ACCO[i].operation,
                                data.ACCO[i].operationAccount,
                                    
                                "<a data-toggle='tooltip' href='#' id='deleteAccounting'title='Eliminar Cuenta'><button onclick=\'deleteAccounting("+JSON.stringify(data.ACCO[i].id)+','+JSON.stringify(data.ACCO[i].account)+")\' class='btn btn-primary btn-sm'><i class='fa fa-trash'></i></button></a>"+
                                "<a data-toggle='tooltip' href='#' id='updateAccounting' title='Actualizar Cuenta'><button  onclick=\'changeUpdateAccounting("+JSON.stringify(data.ACCO[i].id)+','+JSON.stringify(data.ACCO[i].account)+','+JSON.stringify(data.ACCO[i].operation)+','+JSON.stringify(data.ACCO[i].operationAccount)+")\' data-toggle='modal' data-target='#myModalAccountingUpdate' class='btn btn-primary btn-sm'><i class='fa fa-pencil'></i></button></a>"//agregue button
                                ])
                            }
                            tableAccountingOp.draw(false);
                            swal("Creado exitoso de la cuenta!", "Continua con tu proceso!", "success"); 
                        }else{
                            swal("No se puede crear la cuenta", "Ya existe una cuenta con este código", "error");
                        }
					}
				});
			}else {
				alert("Por favor llene todos los campos");
			}
			return false;
        }
        });	
}
function deleteAccounting(id, account){

    swal({
    title: "Desea eliminar la cuenta número " + account + "?",
    text: "Al confirmar esta acción, la cuenta número " + account + " sera eliminada.",
    icon: "warning",
    buttons: true,
    dangerMode: true,
    })
    .then((willDelete) => {
    if (willDelete) {
    
        $.ajax({
            url: '{% url "deleteAll"  0 %}'.replace('0', localStorage.getItem('userID')),
            data: {
                'id': id,
                'option': '--'
            },
            dataType: 'json',
            success: function (data) {   
                var tableAccountingOp = $('#dataTableAccountingOp').DataTable();
                var rows = tableAccountingOp.rows().remove().draw();
                for (var i=0; i<data.AG.length; i++){                      
                    tableAccountingOp.row.add( [

                    data.ACCO[i].account,
                    data.ACCO[i].operation,
                    data.ACCO[i].operationAccount,
                                        
                    "<a data-toggle='tooltip' href='#' id='deleteAccounting'title='Eliminar Cuenta'><button onclick=\'deleteAccounting("+JSON.stringify(data.ACCO[i].id)+','+JSON.stringify(data.ACCO[i].account)+")\' class='btn btn-primary btn-sm'><i class='fa fa-trash'></i></button></a>"+
                    "<a data-toggle='tooltip' href='#' id='updateAccounting' title='Actualizar Cuenta'><button  onclick=\'changeUpdateAccounting("+JSON.stringify(data.ACCO[i].id)+','+JSON.stringify(data.ACCO[i].account)+','+JSON.stringify(data.ACCO[i].operation)+','+JSON.stringify(data.ACCO[i].operationAccount)+")\' data-toggle='modal' data-target='#myModalAccountingUpdate' class='btn btn-primary btn-sm'><i class='fa fa-pencil'></i></button></a>"//agregue button
                    ])
                }
                tableAccountingOp.draw(false); 
                            
                swal("La cuenta número " + account + "  se ha eliminado con éxito.", {
                icon: "success",
                });
                
            }
        });
    }
    });
}
</script>

{% endblock %}
</body>