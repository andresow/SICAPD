{% extends 'base/base.html' %}
{% load bootstrap4 %}
{% block main %}

<body onload="loadTest()">
    <br>
    <br>
    <br>
    <br>
    <br>
        
{% load bootstrap4 %}
<div class="col-lg-8 posts-list" >
	<form id="addAccount">
		<h2>Seleccione el origen</h2>
		<br>	
			<div id="separatorOrigin">
				
			</div>
			<br>		
	</form>
	<div id="separatorOriginButton" style="display:none">
        <button  onclick="generateAccount()" id="generatorAccount" class="genric-btn primary small">GENERAR CUENTA CONTABLE DE</button>
	</div>
</div>
<br>
<div id=divCreateAccount class="container-fluid" style="display:none">
	<div class="card mb-3">
		<div class="card-header"><i class="fas fa-table mr-1"></i>Configuración Cuenta Contable</div>
		<div class="card-body">
                <br>
                <form>
                    <div class="form-row">
                        <div class="col-6">
                            <div  class="container-fluid mb-3" style="float:left">
                                <div class="card" >
                                <div class="card-header mb-3" ><i class="fas fa-table mr-1" ></i>Rubro Presupuesto</div>
                                    <div class="card-body" >
                                        <div class="table-responsive">
                                            
                                            <table class="table table-bordered dataTable" id="dataTableAccountRubro" cellspacing="0" 
                                                role="grid" aria-describedby="dataTable_accountRubro">
                                                
                                                <thead>
                                                    <tr>
                                                        <th>ID</th>
                                                        <th>Rubro</th>
                                                        <th>Descripción</th>
                                                        <th>Tipo</th>
                                                    </tr>
                                                </thead>
                                                <tfoot>
                                                    <tr>
                                                        <th>ID</th>
                                                        <th>Rubro</th>
                                                        <th>Descripción</th>
                                                        <th>Tipo</th>
                                                    </tr>
                                                </tfoot>
                                                </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div id="divAccount" class="container-fluid col-6" style="display:block">
                            <div class="card">
                                <div class="card-header mb-3"><i class="fas fa-table mr-1"></i>Cuentas Contables-Operación-Tipo</div>
                                <form id="createAccuont" class="col-6">
                                    <div class="form-row col-12">
                                        <div class="col-7 mb-4" >
                                            <label>Cuenta:</label>
                                            <select class="form-control" id="accountSelect" name="accountSelect" >
                                            </select>
                                        </div>
                                        <div class="col-5 mb-4" >
                                            <label>Operación:</label>
                                            <select class="form-control" id="operationSelect" name="operationSelect" >
                                                <option  hidden  selected> Selecciona una opción</option>
                                                <option value="Debito">Débito</option>      
                                                <option value="Credito">Crédito</option>
                                            </select>
                                        </div>	                                       
                                    </div>
                                    <div class="col-5 mb-4" >
                                        <label>Operación Cuenta:</label>
                                        <select class="form-control" id="operationAccountSelect" name="operationAccountSelect">
                                            <option  hidden  selected> Selecciona una opción</option>
                                            <option value="Obligacion">Obligación</option>      
                                            <option value="Comprobante de Pago">Comprobante de pago</option>
                                        </select>
                                    </div>
                                    <div class="form-row col-5 mb-4">
                                        <div>
                                            <button onclick="createAccount()" type="button" id="addAccountOperation"class="btn btn-primary">Agregar</button>
                                            <button type="button" class="btn btn-secondary">Cancelar</button>
                                            <button onclick="sendAccounts()" type="button" class="btn btn-primary">Guardar cuentas</button>
                                        </div>					
                                    </div>
                                </form>   
                                <div class="container-fluid mb-2" style="float:left">
                                    <div class="card">
                                    <div class="card-header mb-2" ><i class="fas fa-table mr-1" ></i>Cuenta</div>
                                        <div class="card-body" >
                                            <div class="table-responsive">
                                                <table class="table table-bordered dataTable" id="dataTableAccountingOp" cellspacing="0" 
                                                    role="grid" aria-describedby="dataTable_accountOp">
                                                    
                                                    <thead>
                                                        <tr>
                                                            <th>Rubro</th>
                                                            <th>Cuenta</th>
                                                            <th>Doc. Presupuesto</th>
                                                            <th>Débito-Crédito</th>
                                                            <th>Acciones</th>
                                                        </tr>
                                                    </thead>
                                                    <tfoot>
                                                        <tr>  
                                                            <th>Rubro</th>
                                                            <th>Cuenta</th>
                                                            <th>Doc. Presupuesto</th>
                                                            <th>Débito-Crédito</th>
                                                            <th>Acciones</th>
                                                        </tr>
                                                    </tfoot>
                                                    </table>
                                            </div>    
                                        </div>
                                    </div>
                                </div>  
                            </div>
                        </div>
                    </div>
                </form>	
		</div>	
	</div>
</div>
<script>

var dataRow;
var accountId;
var originID=0;
var accountRubro=[];
var indexTable;
var oTable;

$(document).ready(function() {
		$('#dataTableAccountingOp').DataTable( {
			
		  "destroy":true,
		  "language": idioma_español,
		  
			dom: 'Bfrtip',			
		  }
          
		  );		 	

		$('#dataTableAccountRubro').DataTable( {
            "ordering": false,

            "columnDefs": [
            {
                "targets": [ 0 ],
                "visible": false
            }
        ],
		  "destroy":true,
		  "language": idioma_español,
		  
			dom: 'Bfrtip',			
		  }
		  );	       	 	

    var table = $('#dataTableAccountRubro').DataTable();
 
    $('#dataTableAccountRubro tbody').on( 'click', 'tr', function () {
        if ( $(this).hasClass('selected') ) {
            $(this).removeClass('selected');
        }
        else {
            table.$('tr.selected').removeClass('selected');
            $(this).addClass('selected');
            dataRow = table.row( this ).data();

        }
    } );

 
} );


function loadTest() {	
	$.ajax({
		url: '{% url "getOriginBudget"  0 %}'.replace('0', localStorage.getItem('userID')),
		data: {
			'option': '1',
			'nameAC': localStorage.getItem('nameAC'),
			'idBussines': localStorage.getItem('idBussines'),

		},
		dataType: 'json',
		success: function (data) {
			
		for (var i=0; i<data.OR.length; i++){
			$('#separatorOrigin')
			.append(`<div class="custom-control custom-radio custom-control-inline">
			<input onclick="generateButton()" type="radio" class="custom-control-input" value="`+data.OR[i].nameOrigin+`" id="`+data.OR[i].nameOrigin+`"name="origins">
			<label class="custom-control-label" for="`+data.OR[i].nameOrigin+`">`+data.OR[i].nameOrigin+`</label>
			</div>`)
			}
		}			
	});		
}
function generateButton(){
	var nameOrigin = $('input[name=origins]:checked', '#addAccount').val();
	$("#divCreateAccount").css("display", "none");	
	$("#generatorAccount").text("GENERAR CUENTA CONTABLE DE "+ nameOrigin)															
	$("#separatorOriginButton").css("display", "block");
    $.ajax({
		url: '{% url "getBudget"  0 %}'.replace('0', localStorage.getItem('userID')),
		data: {
			'nameOrigin': nameOrigin,
			'nameAC': localStorage.getItem('nameAC'),
			'idBussines': localStorage.getItem('idBussines')
		},
		dataType: 'json',
		success: function (data) {

			var table = $('#dataTableAccountRubro').DataTable(); 
 			var rows = table.rows().remove().draw();
			originID = data.ID;
			for (var i=0; i<data.RUBRO.length; i++){
				table.row.add( [
                data.RUBRO[i].id,
				data.RUBRO[i].rubro,
				data.RUBRO[i].description,			
				"PRESUPUESTO DE "+nameOrigin,			
				])
			}

			table.draw( false );
										
		}
	});
}
function generateAccount(){
    $("#divCreateAccount").css("display", "block");
    $("#divCreateAccount").css("display", "block");
    $("#divCreateAccount").css("display", "block");
    nameAccount = $("#accountSelect option:selected").text();

    $.ajax({
        url: '{% url "getAccountSettings"  0 %}'.replace('0', localStorage.getItem('userID')),
        data: {
            'bussinesId': localStorage.getItem('idBussines'),
            'idAC': localStorage.getItem('idAC'),

        },
        dataType: 'json',
        success: function (data) {
            const $select = document.querySelector("#accountSelect");
        
            for (let i = $select.options.length; i >= 0; i--) {
                $select.remove(i);
            }
            $('#accountSelect').append(`<option  hidden  selected"> Selecciona una opción</option>`);
            for (var i=0; i<data.ACC.length; i++){
            $('#accountSelect').append(`<option value="${data.ACC[i].id}">${data.ACC[i].code}`+' '+ `${data.ACC[i].description} </option>`);
            }						
        }       
    });
}

function createAccount(){

    var account = $("#accountSelect option:selected").text();
	var operationAccount = $("#operationSelect option:selected").val();
	var document = $("#operationAccountSelect option:selected").val();

    var tableAccountingOp = $('#dataTableAccountingOp').DataTable(); 
    accountRubro.push({"rubro": dataRow[0],"account": $("#accountSelect option:selected").val(),"document": document,"operationAccount":operationAccount})    
    console.log(accountRubro)                              
    tableAccountingOp.row.add( [
        dataRow[1],
        account,
        operationAccount,
        document,                            
        "<a data-toggle='tooltip' type='button' id='deleteAccounting'title='Eliminar Cuenta'><button onclick=\'deleteAccounting()\' class='btn btn-primary btn-sm'><i class='fa fa-trash'></i></button></a>"
    ])
    
    tableAccountingOp.draw(false);
}

function sendAccounts(){
    var token = '{{csrf_token}}';
    $.ajax({
			headers: { "X-CSRFToken": token },
			url: '{% url "createAccountRubro"  0 %}'.replace('0', localStorage.getItem('userID')),
			data: {
				'accountRubro': JSON.stringify(accountRubro),
				'bussines':localStorage.getItem('idBussines'),
			},
			type: 'POST',
			dataType: 'json',
			success: function (data) { 
                if(data.CREATE=="TRUE"){
                    swal("Se ha añadido cuenta", "Continua con tu proceso", "success");
                }else{
                    swal("No se ha podido añadir cuenta", "Esta cuenta ya tiene "+data.TA, "error");
                }
            }       
    });

}
$('#dataTableAccountingOp tbody').on('click', 'tr', function () {
	indexTable=$(this).index();
    console.log(indexTable)
} );

function deleteAccounting(){
    oTable = $('#dataTableAccountingOp').DataTable();
	oTable.row(':eq('+indexTable +')').remove().draw();
	accountRubro.splice(indexTable, 1);
}



</script>

{% endblock %}
</body>